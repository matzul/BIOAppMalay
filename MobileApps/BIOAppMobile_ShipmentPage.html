<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BIOApp Mobile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="img/logo.png" />
    <link href="googleapis/css/fonts.css" rel="stylesheet">
    <link rel="stylesheet" href="normalize/normalize.css">

    <!-- Bootstrap 3.3.6 -->
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" />
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css" />-->

    <!-- Font Awesome -->
    <link rel="stylesheet" href="ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css" />
    <!-- Ionicons -->
    <link rel="stylesheet" href="ajax/libs/ionicons/2.0.1/css/ionicons.min.css" />
    <!-- DataTables -->
    <link rel="stylesheet" href="datatables/css/dataTables.bootstrap.css">

    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/AdminLTE.min.css" />
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/2.4.10/css/AdminLTE.min.css" />-->

    <link rel="stylesheet" href="dist/css/skins/_all-skins.min.css" />
    <!--[if lt IE 9]>
      <script src="html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style>
        body {
            padding: 0px;
            padding-bottom: 50px;
        }

        .mobile-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            will-change: transform;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            display: flex;
            height: 50px;
            box-shadow: 0 -2px 5px -2px #333;
            background-color: #fff;
        }

        .mobile-bottom-nav__item {
            flex-grow: 1;
            text-align: center;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .mobile-bottom-nav__item--active {
            color: red;
        }

        .mobile-bottom-nav__item-content {
            display: flex;
            flex-direction: column;
        }

        /* link */
        .content-wrapper {
            background-color: inherit;
        }

        .pagination {
            float: right !important;
            margin: inherit;
        }

        a {
            text-decoration: none;
            color: #003399;
        }

            a:hover {
                color: #0033cc;
                text-decoration: underline;
            }

            a:active {
                color: #0066FF;
            }

        #wrap {
            position: relative;
            background-image: url(images/wrap.gif);
            background-color: #fff;
        }

        /* clearer */

        /* clearfix */
        .clearfix:after {
            content: ".";
            display: block;
            height: 0;
            clear: both;
            visibility: hidden;
        }

        .clearfix {
            display: inline-table;
            min-height: 1%;
        }
        /* Hides from IE-mac \*/
        * html .clearfix {
            height: 1%;
        }

        .clearfix {
            display: block;
        }
        /* End hide from IE-mac */

        .product_price {
            margin: 0px;
            padding: 5px 10px;
            background-color: #FFF;
            text-align: left;
            border: 2px dashed #E0E0E0
        }
    </style>

    <script>
        window.console = window.console || function (t) { };
    </script>
    <script>
        if (document.location.search.match(/type=embed/gi)) {
            window.parent.postMessage("resize", "*");
        }
    </script>
    <style>
        .breadcrumb {
            margin-bottom: 10px;
        }

        ul.breadcrumb {
            padding: 10px 16px;
            list-style: none;
            background-color: #eee;
        }

            ul.breadcrumb li {
                display: inline;
                font-size: 18px;
            }

                ul.breadcrumb li + li:before {
                    padding: 8px;
                    color: black;
                    content: "/\00a0";
                }

                ul.breadcrumb li a {
                    color: #0275d8;
                    text-decoration: none;
                }

                    ul.breadcrumb li a:hover {
                        color: #01447e;
                        text-decoration: underline;
                    }
    </style>
</head>
<body translate="no">

    <!-- Modal -->
    <div class="modal fade" id="myDIV" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">

                <div class="modal-body">
                    <div class="center-block"><img class="center-block" src="img/loader.gif" width="32" height="32" alt="" /></div>
                    <p class="text-center"> Loading...</p>
                </div>

            </div>
        </div>
    </div>
    <!--END Modal -->

    <div class="wrapper">
        <!-- Content Header (Page header) -->
        <div class="row col-lg-offset-2 col-md-offset-1 col-sm-offset-1 col-lg-8 col-md-10 col-sm-10">
            <section class="content-header">
                <h1>
                    JUALAN
                    <small>BIOApp Mobile</small>
                </h1>
            </section>

            <!-- Main content -->
            <section class="content" style="align-self: center;">
                <ol class="breadcrumb" style="align-self: auto;">
                    <li class="breadcrumb-item"><a href="#" onclick="openlist();"><i class="fa fa-list"></i> Senarai</a></li>
                    <li class="breadcrumb-item"><a href="#" onclick="openorder();">Pesanan</a></li>
                    <li class="breadcrumb-item active">Penghantaran <span id="comp" name="comp"></span></li>
                </ol>
                <div class="menu-info" style="margin-bottom:5px;">
                    <input type="text" id="labelorderno" name="labelorderno" class="col-lg-6 col-md-6 col-sm-6 col-xs-6" readonly="readonly" style="margin-bottom:5px;" placeholder="No. Pesanan:" />
                    <input type="text" id="recordorderno" name="recordorderno" class="col-lg-6 col-md-6 col-sm-6 col-xs-6" readonly="readonly" style="margin-bottom:5px;" placeholder="" />
                    <input type="text" id="labelbpid" name="labelbpid" class="col-lg-6 col-md-6 col-sm-6 col-xs-6" readonly="readonly" style="margin-bottom:5px;" placeholder="Pelanggan:" />
                    <input type="hidden" id="recordbpid" name="recordbpid" />
                    <input type="hidden" id="recordstatus" name="recordstatus" />
                    <input type="text" id="recordbpdesc" name="recordbpdesc" class="col-lg-6 col-md-6 col-sm-6 col-xs-6" readonly="readonly" style="margin-bottom:5px;" placeholder="" />
                </div>
                <div id="tabsShipment" class="nav-tabs-custom">
                    <ul class="nav nav-tabs">
                    </ul>
                    <div class="tab-content">
                        <div class="active tab-pane" id="shipmentitem">

                            <div class="">
                                <div class="pull-left">
                                    <input type="text" id="shipmentstatus" name="shipmentstatus" class="product_price form-control" readonly="readonly" value="" style="text-align:left;" />
                                </div>
                                <div class="pull-right">
                                    <button type="button" class="btn btn-sm" onclick=""><i class="fa fa-print"></i></button>
                                </div>
                                <!-- /.box-header -->
                                <div class="no-padding">

                                    <table id="orderlist" class="table">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th style="display:none;">Comp</th>
                                                <th style="display:none;">ShipmentNo</th>
                                                <th style="display:none;">LineNo</th>
                                                <th style="display:none;">OrderNo</th>
                                                <th style="display:none;">ItemNo</th>
                                                <th style="display:none;">OrderQty</th>
                                                <th style="display:none;">ItemCat</th>
                                                <th>No. Item / Produk</th>
                                                <th>Qty</th>
                                                <th>Inventori</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>

                                </div>
                                <!-- /.box-body -->
                            </div>
                            <!-- /.box -->

                        </div><!-- /.tab-pane-->
                    </div><!-- /.tab-content-->
                </div>
                <div class="menu-info">
                    <a id="btnProcess" name="btnProcess" href="#" class="btn btn-default btn-flat" onclick="processshipment();" style="margin-bottom:5px;">Proses</a>
                    <a id="btnBack" name="btnBack" href="#" onclick="openorder();" class="btn btn-default btn-flat" style="margin-bottom:5px;">Kembali</a>
                </div>
            </section>
            <!-- /.content -->

        </div>
    </div>
    <nav class="mobile-bottom-nav">
        <div id="list" class="mobile-bottom-nav__item">
            <div class="mobile-bottom-nav__item-content">
                <i class="material-icons">menu</i>
                Senarai
            </div>
        </div>
        <div id="order" class="mobile-bottom-nav__item mobile-bottom-nav__item--active">
            <div class="mobile-bottom-nav__item-content">
                <i class="material-icons">shopping_cart</i>
                Jualan
            </div>
        </div>
        <div id="report" class="mobile-bottom-nav__item">
            <div class="mobile-bottom-nav__item-content">
                <i class="material-icons">receipt</i>
                Laporan
            </div>
        </div>
    </nav>

    <!-- JQuery -->
    <script src="https://adminlte.io/themes/AdminLTE/bower_components/jquery/dist/jquery.min.js"></script>
    <!--<script src="dist/js/jquery.min.js"></script>-->
    <!-- Bootstrap 3.3.6 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!--<script src="bootstrap/js/bootstrap.min.js"></script>-->
    <!-- AdminLTE App -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/2.3.11/js/app.min.js"></script>
    <!--<script src="dist/js/app.min.js"></script>-->
    <!-- DataTables -->
    <script src="https://adminlte.io/themes/AdminLTE/bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
    <!--<script src="datatables/js/jquery.dataTables.js"></script>-->

    <script src="https://adminlte.io/themes/AdminLTE/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <!--<script src="datatables/js/bootstrap.dataTables.js"></script>-->

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/JQuery.WebService.Call.Helper.js" type="text/javascript"></script>

    <script id="rendered-js">
        var navItems = document.querySelectorAll(".mobile-bottom-nav__item");
        navItems.forEach(function (e, i) {
            e.addEventListener("click", function (e) {
                navItems.forEach(function (e2, i2) {
                    e2.classList.remove("mobile-bottom-nav__item--active");
                });
                this.classList.add("mobile-bottom-nav__item--active");
                if (this.id == "list") {
                    window.location.href = "BIOAppMobile_OrderList.html?userid=" + userid;
                }
                else if (this.id == "order") {
                    window.location.href = "BIOAppMobile_OrderPage.html?userid=" + userid;
                }
                else if (this.id == "report") {
                    window.location.href = "BIOAppMobile_OrderList.html?userid=" + userid;
                }
            });
        });

        function getParameterByName(name) {
            name = name.replace(/[[]/, "\[").replace(/[]]/, "\]");
            var regex = new RegExp("[\?&]" + name + "=([^&#]*)"), results = regex.exec(location.search);
            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

    </script>
    <script>
        var userid;
        var comp;
        var orderno;
        var ordercat = "SALES_ORDER";
        var pendshipment = 0;
        var saveshipment = false;
        var shipmentno = "";
        var urlhandler = "http://www.bioappsystem.com/bioappmalay/";

        var oTable;


        $(document).ready(function () {

            $('#myDIV').modal({ backdrop: "static" });

            userid = getParameterByName('userid');
            comp = getParameterByName('comp');
            orderno = getParameterByName('orderno');

            $('#comp').text('[' + comp + ']');

            oTable = $('#orderlist').DataTable({
                'paging': false,
                'lengthChange': false,
                'searching': false,
                'ordering': true,
                'info': false,
                'autoWidth': true,
                "columnDefs": [
                    {
                        "targets": [1],
                        "visible": false,
                        "searchable": false
                    },
                    {
                        "targets": [2],
                        "visible": false
                    },
                    {
                        "targets": [3],
                        "visible": false
                    },
                    {
                        "targets": [4],
                        "visible": false
                    },
                    {
                        "targets": [5],
                        "visible": false
                    },
                    {
                        "targets": [6],
                        "visible": false
                    },
                    {
                        "targets": [7],
                        "visible": false
                    }
                ]
            });

            if (comp && comp.length) {
                if (orderno && orderno.length) {

                    var parameters_getMobile_OrderDetails = ["comp", comp, "orderno", orderno];
                    PageMethod("getMobile_OrderDetails", parameters_getMobile_OrderDetails, succeededAjaxFn_getMobile_OrderDetails, failedAjaxFn_getMobile_OrderDetails, false);

                    var parameters_getMobile_OrderShipmentList = ["comp", comp, "orderno", orderno];
                    PageMethod("getMobile_OrderShipmentList", parameters_getMobile_OrderShipmentList, succeededAjaxFn_getMobile_OrderShipmentList, failedAjaxFn_getMobile_OrderShipmentList, false);

                } else {

                }
            } else {
                alert('Internal system error!');
            }

            $('#myDIV').modal('hide');
        })

        succeededAjaxFn_getMobile_OrderDetails = function (data, textStatus, jqXHR) {
            console.log("succeededAjaxFn_getMobile_OrderDetails: " + textStatus);
            //oTable.dataTable().fnClearTable();
            oTable.clear().draw();

            result_getMobile_OrderDetails = JSON.parse(data.d);
            $('#recordorderno').val(result_getMobile_OrderDetails.GetSetorderno);
            $('#recordbpid').val(result_getMobile_OrderDetails.GetSetbpid);
            $('#recordstatus').val(result_getMobile_OrderDetails.GetSetorderstatus);
            $('#recordbpdesc').val(result_getMobile_OrderDetails.GetSetbpdesc);
        }

        //notification for failed ajax transaction
        failedAjaxFn_getMobile_OrderDetails = function (jqXHR, textStatus, errorThrown) {
            console.log("failedAjaxFn_getMobile_OrderDetails: " + textStatus);
        }

        succeededAjaxFn_getMobile_OrderShipmentList = function (data, textStatus, jqXHR) {
            console.log("succeededAjaxFn_getMobile_OrderShipmentList: " + textStatus);

            checkPendingShipmentItem();

            result_getMobile_OrderShipmentList = JSON.parse(data.d);
            if (result_getMobile_OrderShipmentList.countshipment > 0) {
                $.each(result_getMobile_OrderShipmentList.arrayshipmentno, function (i, result) {
                    var num_tabs = $('div#tabsShipment ul li').length + 1;

                    $('div#tabsShipment ul').append(
                        '<li ' + (i == 0 ? 'class="active"' : '') +'><a href="#shipmentitem" data-toggle="tab" onclick="getShipmentItem(\'' + result +'\');">' + result + '</a></li>'
                    );
                    if (i == 0) {
                        var parameters_getMobile_OrderShipmentItem = ["comp", comp, "orderno", orderno, "shipmentno", result];
                        PageMethod("getMobile_OrderShipmentItem", parameters_getMobile_OrderShipmentItem, succeededAjaxFn_getMobile_OrderShipmentItem, failedAjaxFn_getMobile_OrderShipmentItem, false);

                        $('#btnProcess').hide();
                    }
                });

                //check if pending shipment item exist or not?
                if (pendshipment != 0) {

                    var num_tabs = $('div#tabsShipment ul li').length + 1;

                    $('div#tabsShipment ul').append(
                        '<li><a href="#shipmentitem" data-toggle="tab" onclick="getPendingShipmentItem();">BARU</a></li>'
                    );
                }
            }
            else
            {
                var num_tabs = $('div#tabsShipment ul li').length + 1;

                $('div#tabsShipment ul').append(
                    '<li class="active"><a href="#shipmentitem" data-toggle="tab" onclick="getNewShipmentItem();">BARU</a></li>'
                );

                var parameters_getMobile_OrderItems = ["comp", comp, "orderno", orderno];
                PageMethod("getMobile_OrderItems", parameters_getMobile_OrderItems, succeededAjaxFn_getMobile_OrderItems, failedAjaxFn_getMobile_OrderItems, false);

                if (pendshipment != 0) {
                    $('#btnProcess').show();
                }
                else
                {
                    $('#btnProcess').hide();
                }
            }

        }

        //notification for failed ajax transaction
        failedAjaxFn_getMobile_OrderShipmentList = function (jqXHR, textStatus, errorThrown) {
            console.log("failedAjaxFn_getMobile_OrderShipmentList: " + textStatus);
            $('#btnProcess').hide();
        }

        function getShipmentItem(shipmentno) {
            $('#myDIV').modal({ backdrop: "static" });

            var parameters_getMobile_OrderShipmentItem = ["comp", comp, "orderno", orderno, "shipmentno", shipmentno];
            PageMethod("getMobile_OrderShipmentItem", parameters_getMobile_OrderShipmentItem, succeededAjaxFn_getMobile_OrderShipmentItem, failedAjaxFn_getMobile_OrderShipmentItem, false);

            $('#btnProcess').hide();

            $('#myDIV').modal('hide');
        }

        succeededAjaxFn_getMobile_OrderShipmentItem = function (data, textStatus, jqXHR) {
            console.log("succeededAjaxFn_getMobile_OrderShipmentItem: " + textStatus);
            //oTable.dataTable().fnClearTable();
            oTable.clear().draw();

            result_getMobile_OrderShipmentItem = JSON.parse(data.d);
            $.each(result_getMobile_OrderShipmentItem, function (i, result) {

                $('#shipmentstatus').val(result.GetSetstatus);
                oTable.row.add([
                    i+1,
                    result.GetSetcomp,
                    result.GetSetshipmentno,
                    result.GetSetlineno,
                    result.GetSetorderno,
                    result.GetSetitemno,
                    result.GetSetshipment_quantity,
                    result.GetSetitemcat,
                    result.GetSetitemno + '<br/>' + result.GetSetitemdesc,
                    result.GetSetshipment_quantity,
                    result.GetSetlocation
                ]).draw(false);
            });
        }

        //notification for failed ajax transaction
        failedAjaxFn_getMobile_OrderShipmentItem = function (jqXHR, textStatus, errorThrown) {
            console.log("failedAjaxFn_getMobile_OrderShipmentItem: " + textStatus);
        }

        function checkPendingShipmentItem() {
            var parameters_check_PendingShipmentList = ["comp", comp, "bpid", $('#recordbpid').val(), "orderno", orderno, "ordercat", ordercat];
            PageMethod("getMobile_PendingShipmentList", parameters_check_PendingShipmentList, succeededAjaxFn_check_PendingShipmentList, failedAjaxFn_check_PendingShipmentList, false);
        }

        succeededAjaxFn_check_PendingShipmentList = function (data, textStatus, jqXHR) {
            console.log("succeededAjaxFn_check_PendingShipmentList: " + textStatus);
            oTable.clear().draw();

            result = JSON.parse(data.d);
            if ($('#recordstatus').val() != 'CANCELLED') {
                pendshipment = result.countpendshipment;
            } else {
                pendshipment = 0;
            }
        }

        //notification for failed ajax transaction
        failedAjaxFn_check_PendingShipmentList = function (jqXHR, textStatus, errorThrown) {
            console.log("failedAjaxFn_check_PendingShipmentList: " + textStatus);
            pendshipment = 0;
        }

        function getPendingShipmentItem() {
            $('#myDIV').modal({ backdrop: "static" });

            var parameters_getMobile_PendingShipmentList = ["comp", comp, "bpid", $('#recordbpid').val(), "orderno", orderno, "ordercat", ordercat];
            PageMethod("getMobile_PendingShipmentList", parameters_getMobile_PendingShipmentList, succeededAjaxFn_getMobile_PendingShipmentList, failedAjaxFn_getMobile_PendingShipmentList, false);

            $('#btnProcess').show();

            $('#myDIV').modal('hide');
        }

        succeededAjaxFn_getMobile_PendingShipmentList = function (data, textStatus, jqXHR) {
            console.log("succeededAjaxFn_getMobile_PendingShipmentList: " + textStatus);
            oTable.clear().draw();

            result_getMobile_PendingShipmentList = JSON.parse(data.d);
            $.each(result_getMobile_PendingShipmentList.arraypendshipmentno, function (i, result) {
                oTable.row.add([
                    i+1,
                    result.GetSetcomp,
                    result.GetSetshipmentno,
                    result.GetSetlineno,
                    result.GetSetorderno,
                    result.GetSetitemno,
                    result.GetSetorder_quantity,
                    result.GetSetitemcat,
                    result.GetSetitemno + '<br/>' + result.GetSetitemdesc + '<br/>Qty Order: ' + result.GetSetorder_quantity,
                    '<input id="qty_shipment_' + result.GetSetlineno + '" name="qty_shipment' + result.GetSetlineno + '" type="text" value="' + result.GetSetquantity + '" style="width:30px;"/>',
                    '<select id="location_shipment' + result.GetSetlineno + '" name="location_shipment' + result.GetSetlineno + ' class="select form-control"><option value="">-Select-</option></select><input type="text" id="item_location' + result.GetSetlineno + '" name="item_location' + result.GetSetlineno + '" value ="" readonly class="product_price form-control"/><input type="text" id ="item_datesoh' + result.GetSetlineno + '" name="item_datesoh' + result.GetSetlineno + '" value="" readonly class="product_price form-control"/><input type="text" id="item_qtyavailable' + result.GetSetlineno + '" name="item_qtyavailable' + result.GetSetlineno + '" value="" readonly class="product_price form-control"/>'
                ]).draw(false);
            });

            oTable.rows().every(function (x, element) {
                var data = this.data();
                //get location stock availability
                $.getJSON(urlhandler + "/GeneralHandler.ashx?action=GET_STOCKAVAILABLE&comp=" + comp + "&itemno=" + data[5],
                    function (mps) {
                        //reset stockavailable, hidden field of stock information & balance order qty
                        var select = document.getElementById("location_shipment" + data[3]);
                        for (var option in select) {
                            select.remove(option);
                        }
                        document.getElementById("location_shipment" + data[3]).add(new Option("-Select-", ""));

                        var x = 0;
                        for (var i in mps) {
                            //pure javascript
                            var x = x + 1;
                            document.getElementById("location_shipment" + data[3]).add(new Option("STOK " + x, mps[i].item + "|" + mps[i].location + "|" + mps[i].datesoh + "|" + mps[i].qtysoh + "|" + mps[i].qtyavailable));
                            //using jquery
                        }

                        $('#location_shipment' + data[3]).change(function () {
                            if ($(this).val() == '') {
                                $('#item_location' + data[3]).val('');
                                $('#item_datesoh' + data[3]).val('');
                                $('#item_qtyavailable' + data[3]).val('0');
                                if (data[7] == "SERVICE") {
                                    $('#qty_shipment_' + data[3]).val(setQtyToShipment(data[6], data[6]));
                                } else {
                                    $('#qty_shipment_' + data[3]).val(setQtyToShipment(0, 0));
                                }
                            } else {
                                //get latest information about stockavailability
                                var stockitem = $(this).val().split('|');
                                $('#item_location' + data[3]).val(stockitem[1]);
                                $('#item_datesoh' + data[3]).val(stockitem[2]);
                                $('#item_qtyavailable' + data[3]).val(stockitem[4]);
                                $('#qty_shipment_' + data[3]).val(setQtyToShipment(data[6], stockitem[4]));
                            }
                        });

                        //console.log('#location_shipment' + data[3] + ": " + document.getElementById("location_shipment" + data[3]).options.length-1);
                        $('#location_shipment' + data[3]).prop('selectedIndex', document.getElementById("location_shipment" + data[3]).options.length - 1);

                        if ($('#location_shipment' + data[3]).val() == '') {
                            $('#item_location' + data[3]).val('');
                            $('#item_datesoh' + data[3]).val('');
                            $('#item_qtyavailable' + data[3]).val('0');
                            if (data[7] == "SERVICE") {
                                $('#qty_shipment_' + data[3]).val(setQtyToShipment(data[6], data[6]));
                            } else {
                                $('#qty_shipment_' + data[3]).val(setQtyToShipment(0, 0));
                            }
                        } else {
                            //get latest information about stockavailability
                            var stockitem = $('#location_shipment' + data[3]).val().split('|');
                            $('#item_location' + data[3]).val(stockitem[1]);
                            $('#item_datesoh' + data[3]).val(stockitem[2]);
                            $('#item_qtyavailable' + data[3]).val(stockitem[4]);
                            $('#qty_shipment_' + data[3]).val(setQtyToShipment(data[6], stockitem[4]));
                        }

                        //setSelectedIndexByIndex(document.getElementById("location_shipment" + data[3]), document.getElementById("location_shipment" + data[3]).options.length);

                    });

            });

        }

        //notification for failed ajax transaction
        failedAjaxFn_getMobile_PendingShipmentList = function (jqXHR, textStatus, errorThrown) {
            console.log("failedAjaxFn_getMobile_PendingShipmentList: " + textStatus);
        }

        function getNewShipmentItem() {
            $('#myDIV').modal({ backdrop: "static" });

            var parameters_getMobile_OrderItems = ["comp", comp, "orderno", orderno];
            PageMethod("getMobile_OrderItems", parameters_getMobile_OrderItems, succeededAjaxFn_getMobile_OrderItems, failedAjaxFn_getMobile_OrderItems, false);

            $('#btnProcess').show();

            $('#myDIV').modal('hide');
        }

        succeededAjaxFn_getMobile_OrderItems = function (data, textStatus, jqXHR) {
            console.log("succeededAjaxFn_getMobile_OrderItems: " + textStatus);
            oTable.clear().draw();

            result_getMobile_OrderItems = JSON.parse(data.d);
            if ($('#recordstatus').val() != 'CANCELLED') {
                $.each(result_getMobile_OrderItems, function (i, result) {
                    oTable.row.add([
                        i+1,
                        result.GetSetcomp,
                        result.GetSetshipmentno,
                        result.GetSetlineno,
                        result.GetSetorderno,
                        result.GetSetitemno,
                        result.GetSetquantity,
                        result.GetSetitemcat,
                        result.GetSetitemno + '<br/>' + result.GetSetitemdesc + '<br/>Qty Order: ' + result.GetSetquantity,
                        '<input id="qty_shipment_' + result.GetSetlineno + '" name="qty_shipment' + result.GetSetlineno + '" type="text" value="' + result.GetSetquantity + '" style="width:30px;"/>',
                        '<select id="location_shipment' + result.GetSetlineno + '" name="location_shipment' + result.GetSetlineno + ' class="select form-control"><option value="">-Select-</option></select><input type="text" id="item_location' + result.GetSetlineno + '" name="item_location' + result.GetSetlineno + '" value ="" readonly class="product_price form-control"/><input type="text" id ="item_datesoh' + result.GetSetlineno + '" name="item_datesoh' + result.GetSetlineno + '" value="" readonly class="product_price form-control"/><input type="text" id="item_qtyavailable' + result.GetSetlineno + '" name="item_qtyavailable' + result.GetSetlineno + '" value="" readonly class="product_price form-control"/>'
                        //'<select id="location_shipment' + result.GetSetlineno + '" name="location_shipment' + result.GetSetlineno + ' class="form-control"><option value="">-Select-</option></select><span id="item_location' + result.GetSetlineno + '" name="item_location' + result.GetSetlineno + '"/><span id="item_datesoh' + result.GetSetlineno + '" name="item_datesoh' + result.GetSetlineno + '" /><span id="item_qtyavailable' + result.GetSetlineno + '" name="item_qtyavailable' + result.GetSetlineno + '"/>'
                    ]).draw(false);

                    pendshipment = pendshipment + 1;

                });

                oTable.rows().every(function (x, element) {
                    var data = this.data();
                    //get location stock availability
                    $.getJSON(urlhandler + "/GeneralHandler.ashx?action=GET_STOCKAVAILABLE&comp=" + comp + "&itemno=" + data[5],
                        function (mps) {
                            //reset stockavailable, hidden field of stock information & balance order qty
                            var select = document.getElementById("location_shipment" + data[3]);
                            for (var option in select) {
                                select.remove(option);
                            }
                            document.getElementById("location_shipment" + data[3]).add(new Option("-Select-", ""));

                            var x = 0;
                            for (var i in mps) {
                                //pure javascript
                                var x = x + 1;
                                document.getElementById("location_shipment" + data[3]).add(new Option("STOK " + x, mps[i].item + "|" + mps[i].location + "|" + mps[i].datesoh + "|" + mps[i].qtysoh + "|" + mps[i].qtyavailable));
                                //using jquery
                            }

                            $('#location_shipment' + data[3]).change(function () {
                                if ($(this).val() == '') {
                                    $('#item_location' + data[3]).val('');
                                    $('#item_datesoh' + data[3]).val('');
                                    $('#item_qtyavailable' + data[3]).val('0');
                                    if (data[7] == "SERVICE") {
                                        $('#qty_shipment_' + data[3]).val(setQtyToShipment(data[6], data[6]));
                                    } else {
                                        $('#qty_shipment_' + data[3]).val(setQtyToShipment(0, 0));
                                    }
                                } else {
                                    //get latest information about stockavailability
                                    var stockitem = $(this).val().split('|');
                                    $('#item_location' + data[3]).val(stockitem[1]);
                                    $('#item_datesoh' + data[3]).val(stockitem[2]);
                                    $('#item_qtyavailable' + data[3]).val(stockitem[4]);
                                    $('#qty_shipment_' + data[3]).val(setQtyToShipment(data[6],stockitem[4]));
                                }
                            });

                            //console.log('#location_shipment' + data[3] + ": " + document.getElementById("location_shipment" + data[3]).options.length-1);
                            $('#location_shipment' + data[3]).prop('selectedIndex', document.getElementById("location_shipment" + data[3]).options.length - 1); 

                            if ($('#location_shipment' + data[3]).val() == '') {
                                $('#item_location' + data[3]).val('');
                                $('#item_datesoh' + data[3]).val('');
                                $('#item_qtyavailable' + data[3]).val('0');
                                if (data[7] == "SERVICE") {
                                    $('#qty_shipment_' + data[3]).val(setQtyToShipment(data[6], data[6]));
                                } else {
                                    $('#qty_shipment_' + data[3]).val(setQtyToShipment(0, 0));
                                }
                            } else {
                                //get latest information about stockavailability
                                var stockitem = $('#location_shipment' + data[3]).val().split('|');
                                $('#item_location' + data[3]).val(stockitem[1]);
                                $('#item_datesoh' + data[3]).val(stockitem[2]);
                                $('#item_qtyavailable' + data[3]).val(stockitem[4]);
                                $('#qty_shipment_' + data[3]).val(setQtyToShipment(data[6], stockitem[4]));
                            }

                            //setSelectedIndexByIndex(document.getElementById("location_shipment" + data[3]), document.getElementById("location_shipment" + data[3]).options.length);

                        });

                });

            } else {
                pendshipment = 0;
            }
        }

        //notification for failed ajax transaction
        failedAjaxFn_getMobile_OrderItems = function (jqXHR, textStatus, errorThrown) {
            console.log("failedAjaxFn_getMobile_OrderItems: " + textStatus);
            pendshipment = 0;
        }

        function processshipment() {
            $('#myDIV').modal({ backdrop: "static" });
            var proceedprocess = false;

            if (pendshipment > 0) {
                oTable.rows().every(function (i, element) {
                    var data = this.data();
                    if ($('#qty_shipment_' + data[3]).val() != "0") {
                        proceedprocess = true;
                    }
                });
                if (proceedprocess) {
                    //confirm receive order 1st
                    var parameters_updateMobile_OrderOrderStatus = ["comp", comp, "orderno", orderno, "status", "CONFIRMED", "userid", userid];
                    PageMethod("updateMobile_OrderOrderStatus", parameters_updateMobile_OrderOrderStatus, succeededAjaxFn_updateMobile_OrderOrderStatus, failedAjaxFn_updateMobile_OrderOrderStatus, false);

                    if (saveshipment) {
                        //create shipment order
                        var parameters_createMobile_ShipmentOrder = ["comp", comp, "orderno", orderno, "userid", userid];
                        PageMethod("createMobile_ShipmentOrder", parameters_createMobile_ShipmentOrder, succeededAjaxFn_createMobile_ShipmentOrder, failedAjaxFn_createMobile_ShipmentOrder, false);

                        if (saveshipment && shipmentno != "") {
                            //add line item for shipment order
                            var x = 1;
                            oTable.rows().every(function (i, element) {
                                var data = this.data();
                                //alert(data[1] + ":" + data[3] + ":" + data[4] + ":" + data[5] + ":" + $('#qty_shipment_' + i).val() + ":" + $('#location_shipment' + i).val());
                                if ($('#qty_shipment_' + data[3]).val() != "0") {
                                    var parameters_addMobile_ShipmentItemOrder = ["comp", comp, "shipmentno", shipmentno, "shipmentlineno", x, "orderno", orderno, "lineno", data[3], "itemno", data[5], "qty", $('#qty_shipment_' + data[3]).val(), "location", $('#item_location' + data[3]).val(), "datesoh", $('#item_datesoh' + data[3]).val(), "qtyavailable", $('#item_qtyavailable' + data[3]).val()];
                                    PageMethod("addMobile_ShipmentItemOrder", parameters_addMobile_ShipmentItemOrder, succeededAjaxFn_addMobile_ShipmentItemOrder, failedAjaxFn_addMobile_ShipmentItemOrder, false);
                                }
                                x = x + 1;
                            });

                            //confirm shipment order
                            var parameters_updateMobile_ShipmentOrderStatus = ["comp", comp, "shipmentno", shipmentno, "status", "CONFIRMED", "userid", userid];
                            PageMethod("updateMobile_ShipmentOrderStatus", parameters_updateMobile_ShipmentOrderStatus, succeededAjaxFn_updateMobile_ShipmentOrderStatus, failedAjaxFn_updateMobile_ShipmentOrderStatus, false);

                            if (saveshipment) {
                                window.location.href = "BIOAppMobile_ShipmentPage.html?userid=" + userid + "&comp=" + comp + "&orderno=" + orderno;
                            }
                        }
                    }

                    if (saveshipment == false) {
                        alert("Internal Server Error!");
                    }
                }
            }

            $('#myDIV').modal('hide');
        }

        succeededAjaxFn_updateMobile_OrderOrderStatus = function (data, textStatus, jqXHR) {
            console.log("succeededAjaxFn_updateMobile_OrderOrderStatus: " + textStatus);

            result = JSON.parse(data.d);
            if (result.status == "Y") {
                saveshipment = true;
            }
            else {
                saveshipment = false;
            }
        }

        //notification for failed ajax transaction
        failedAjaxFn_updateMobile_OrderOrderStatus = function (jqXHR, textStatus, errorThrown) {
            console.log("failedAjaxFn_updateMobile_OrderOrderStatus: " + textStatus);
            saveshipment = false;
        }

        succeededAjaxFn_createMobile_ShipmentOrder = function (data, textStatus, jqXHR) {
            console.log("succeededAjaxFn_createMobile_ShipmentOrder: " + textStatus);

            result = JSON.parse(data.d);
            if (result.status == "Y") {
                saveshipment = true;
                shipmentno = result.message;
            } else {
                saveshipment = false;
                shipmentno = "";
            }
        }

        //notification for failed ajax transaction
        failedAjaxFn_createMobile_ShipmentOrder = function (jqXHR, textStatus, errorThrown) {
            console.log("failedAjaxFn_createMobile_ShipmentOrder: " + textStatus);
            saveshipment = false;
            shipmentno = "";
        }


        succeededAjaxFn_addMobile_ShipmentItemOrder = function (data, textStatus, jqXHR) {
            console.log("succeededAjaxFn_addMobile_ShipmentItemOrder: " + textStatus);

            result = JSON.parse(data.d);
            if (result.status == "Y") {
                saveshipment = true;
            }
            else {
                saveshipment = false;
            }
        }

        //notification for failed ajax transaction
        failedAjaxFn_addMobile_ShipmentItemOrder = function (jqXHR, textStatus, errorThrown) {
            console.log("failedAjaxFn_addMobile_ShipmentItemOrder: " + textStatus);
            saveshipment = false;
        }

        succeededAjaxFn_updateMobile_ShipmentOrderStatus = function (data, textStatus, jqXHR) {
            console.log("succeededAjaxFn_updateMobile_ShipmentOrderStatus: " + textStatus);

            result = JSON.parse(data.d);
            if (result.status == "Y") {
                saveshipment = true;
            }
            else {
                saveshipment = false;
            }
        }

        //notification for failed ajax transaction
        failedAjaxFn_updateMobile_ShipmentOrderStatus = function (jqXHR, textStatus, errorThrown) {
            console.log("failedAjaxFn_updateMobile_ShipmentOrderStatus: " + textStatus);
            saveshipment = false;
        }

        function openlist() {
            window.location.href = "BIOAppMobile_OrderList.html?userid=" + userid;
        }

        function openorder() {
            window.location.href = "BIOAppMobile_OrderPage.html?userid=" + userid + "&comp=" + comp + "&orderno=" + orderno;
        }

        function setSelectedIndexByName(s, v) {
            for (var i = 0; i < s.options.length; i++) {
                if (s.options[i].text == v) {
                    s.options[i].selected = true;
                    return;
                }
            }
        }

        function setSelectedIndexByValue(s, valsearch) {
            // Loop through all the items in drop down list
            for (i = 0; i < s.options.length; i++) {
                if (s.options[i].value == valsearch) {
                    // Item is found. Set its property and exit
                    s.options[i].selected = true;
                    break;
                }
            }
            return;
        }

        function setSelectedIndexByIndex(s, i) {
            s.options[i - 1].selected = true;
            return;
        }

        function setQtyToShipment(qtyorder, qtyavailable) {
            if (qtyavailable > qtyorder) {
                return qtyorder;
            } else {
                return qtyavailable;
            }
        }

    </script>
</body>
</html>
